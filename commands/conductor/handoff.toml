description = "Create context handoff summary for transferring implementation to next section/session"
prompt = """
## 1.0 SYSTEM DIRECTIVE
You are an AI agent assistant for the Conductor spec-driven development framework. Your current task is to create a comprehensive context handoff for transferring implementation progress to a new section or session. This is critical for large tasks that span multiple context windows.

CRITICAL: This command preserves implementation context when you need to continue work in a fresh context window.

---

## 1.1 SETUP CHECK
**PROTOCOL: Verify that the Conductor environment is properly set up.**

1.  **Check for Required Files:** You MUST verify the existence of the following files in the `conductor` directory:
    -   `conductor/tech-stack.md`
    -   `conductor/workflow.md`
    -   `conductor/product.md`

2.  **Handle Missing Files:**
    -   If ANY of these files are missing, you MUST halt the operation immediately.
    -   Announce: "Conductor is not set up. Please run `/conductor:setup` to set up the environment."
    -   Do NOT proceed.

---

## 2.0 IDENTIFY ACTIVE TRACK
**PROTOCOL: Find the track currently being implemented.**

1.  **Parse Tracks File:** Read `conductor/tracks.md` and find the track marked with `[~]` (in progress).

2.  **Handle No Active Track:**
    -   If no track is marked `[~]`, check if user provided a track argument.
    -   If still no track identified, announce: "No active track found. Please specify a track or start implementation first."
    -   Halt the process.

3.  **Load Track Context:**
    -   Read `conductor/tracks/<track_id>/spec.md`
    -   Read `conductor/tracks/<track_id>/plan.md`
    -   Read `conductor/tracks/<track_id>/implement_state.json` (if exists)
    -   Check for `conductor/tracks/<track_id>/parallel_state.json`

4.  **Parallel Execution Check:**
    -   If `parallel_state.json` exists:
        > "‚ö†Ô∏è This track has parallel workers currently running:"
        > [List workers and their status from parallel_state.json]
        > 
        > "A) Wait for workers to complete before handoff"
        > "B) Create handoff anyway (workers will continue)"
        > "C) Cancel handoff"
        -   If A: Monitor `parallel_state.json` until all workers complete, then proceed
        -   If B: Include parallel state in handoff document, proceed
        -   If C: HALT

---

## 3.0 GATHER HANDOFF CONTEXT
**PROTOCOL: Collect all relevant implementation context.**

1.  **Analyze Current Progress:**
    a.  **From implement_state.json:** Extract current phase, task index, completed phases, section count
    b.  **From plan.md:** Count completed `[x]`, in-progress `[~]`, and pending `[ ]` tasks
    c.  **Calculate:** Overall progress percentage

2.  **Identify Recent Changes:**
    a.  **Git Analysis:** Run `git log --oneline -10` to get recent commits
    b.  **Changed Files:** Run `git diff --name-only HEAD~5` (or since last checkpoint) to identify recently modified files
    c.  **Key Decisions:** Ask user for any important implementation decisions made in this section

3.  **Identify Unresolved Issues:**
    a.  **Check for blocked tasks:** Look for `[!]` markers in plan.md
    b.  **Check blockers.md:** Read if exists
    c.  **Ask user:** "Are there any unresolved issues or decisions that need to be carried forward?"

4.  **Determine Next Steps:**
    a.  **Identify next task:** Find the next `[ ]` or `[~]` task in plan.md
    b.  **Identify next phase:** If current phase is nearly complete, note the upcoming phase
    c.  **Note dependencies:** Any tasks that depend on external factors

---

## 4.0 UPDATE IMPLEMENTATION STATE
**PROTOCOL: Update state file with section tracking.**

1.  **Read or Create State:** Load `conductor/tracks/<track_id>/implement_state.json`

2.  **Update Section Info:**
    ```json
    {
      "current_phase": "<phase_name>",
      "current_phase_index": <n>,
      "current_task_index": <n>,
      "completed_phases": ["Phase 1", ...],
      "section_count": <incremented>,
      "last_handoff": "<ISO timestamp>",
      "handoff_history": [
        {
          "section": <n>,
          "timestamp": "<ISO>",
          "phase_at_handoff": "<phase_name>",
          "task_at_handoff": <task_index>,
          "handoff_file": "handoff_<timestamp>.md"
        }
      ],
      "status": "handed_off",
      "last_updated": "<ISO timestamp>"
    }
    ```

3.  **Write State:** Save the updated state file.

---

## 5.0 CREATE HANDOFF DOCUMENT
**PROTOCOL: Generate comprehensive handoff summary.**

1.  **Generate Timestamp:** Create timestamp in format `YYYYMMDD_HHMMSS`

2.  **Create Handoff File:** Write to `conductor/tracks/<track_id>/handoff_<timestamp>.md`:

    ```markdown
    # Implementation Handoff - Section <N>

    **Track:** <track_description>
    **Track ID:** <track_id>
    **Created:** <timestamp>
    **Previous Section:** <link to previous handoff if exists>

    ---

    ## Progress Summary

    **Overall Progress:** <X>% complete (<completed>/<total> tasks)
    **Current Phase:** <phase_name> (Phase <N> of <total_phases>)
    **Current Task:** <task_description>

    ### Completed in This Section
    - [x] <task 1> (commit: <sha>)
    - [x] <task 2> (commit: <sha>)
    ...

    ### In Progress
    - [~] <current task>

    ### Remaining
    - [ ] <next task 1>
    - [ ] <next task 2>
    ...

    ---

    ## Key Implementation Decisions

    <List important decisions made during this section that affect future work>

    1. **<Decision Area>:** <What was decided and why>
    2. ...

    ---

    ## Code Changes Summary

    ### Files Modified
    - `<file_path>` - <brief description of changes>
    ...

    ### New Files Created
    - `<file_path>` - <purpose>
    ...

    ### Recent Commits
    ```
    <git log output>
    ```

    ---

    ## Unresolved Issues

    <List any blockers, questions, or issues that need attention>

    - **<Issue 1>:** <description>
    - ...

    ---

    ## Context for Next Section

    ### Critical Information
    <Important context that MUST be understood before continuing>

    ### Architecture Notes
    <Any architectural decisions or patterns being followed>

    ### Testing Status
    - Tests passing: <yes/no>
    - Coverage: <percentage if known>
    - Failing tests: <list if any>

    ---

    ## Next Steps

    ### Immediate (Next Task)
    1. <Specific first action to take>
    2. <Second action>

    ### Upcoming (This Phase)
    - <remaining tasks in current phase>

    ### Future Phases
    - **<Phase N+1>:** <brief description>
    - ...

    ---

    ## Resume Instructions

    To continue implementation in a new section:

    1. Run `/conductor:implement <track_id>` (or `/conductor-implement <track_id>`)
    2. The state will auto-resume from: **<current_phase>**, Task <current_task_index + 1>
    3. Review this handoff document for context
    4. Continue with: <specific next action>

    ---

    *Handoff created by Conductor - Section <N> complete*
    ```

3.  **Handle Previous Handoffs:** If previous handoff files exist, add link reference.

---

## 6.0 COMMIT HANDOFF
**PROTOCOL: Commit the handoff state.**

1.  **Stage Changes:**
    ```bash
    git add conductor/tracks/<track_id>/implement_state.json
    git add conductor/tracks/<track_id>/handoff_*.md
    ```

2.  **Commit:**
    ```bash
    git commit -m "conductor(handoff): Create section <N> handoff for <track_id>

    Progress: <X>% complete
    Phase: <current_phase>
    Next: <next_task_brief>"
    ```

---

## 7.0 PRESENT HANDOFF SUMMARY
**PROTOCOL: Provide user with clear handoff information.**

1.  **Display Summary:**
    ```
    ## ‚úÖ Handoff Complete

    **Track:** <track_description>
    **Section:** <N> ‚Üí <N+1>
    **Progress:** <X>% complete

    ### Handoff Document
    üìÑ `conductor/tracks/<track_id>/handoff_<timestamp>.md`

    ### Resume Command
    ```
    /conductor:implement <track_id>
    ```
    or
    ```
    /conductor-implement <track_id>
    ```

    ### Next Action
    <specific next task to work on>

    ---

    üí° **Tip:** Share the handoff document with the next session for full context.
    ```

2.  **Offer Options:**
    ```
    What would you like to do?
    A) End session here (handoff saved)
    B) Continue in this session (handoff saved as checkpoint)
    C) View full handoff document
    ```

---

## 8.0 ERROR HANDLING

1.  **No Git Repository:** If git commands fail, still create handoff document but warn about missing commit tracking.

2.  **Missing Files:** If spec.md or plan.md missing, create partial handoff with available information.

3.  **State Corruption:** If implement_state.json is corrupted, recreate from plan.md analysis.

---

## 9.0 BEADS HANDOFF SYNC

**PROTOCOL: Save handoff context to Beads for compaction-proof resumability.**

1.  **Check Beads CLI:**
    - Execute `which bd` to check if the Beads CLI is available
    - If `bd` is not found, present the following prompt:
        > "‚ö†Ô∏è Beads CLI (`bd`) is not installed. Beads provides persistent task memory across sessions.
        > A) Continue handoff without Beads sync
        > B) Stop - I'll install Beads first
        >
        > Please respond with A or B."
        - **If A:** Skip remaining Beads steps.
        - **If B:** HALT and wait for user to install Beads.
    - If `bd` is found, continue to update epic with handoff note.

2.  **Update Epic with Handoff Note:**
    - Read `beads_epic` and `beads_tasks` mapping from track's metadata.json
    - Run `bd note <beads_epic> "HANDOFF Section <N>: <progress>% complete. Current: <phase> - <task>. Next: <next_action>"`
    - **Error Handling:** If `bd` command fails:
        > "‚ö†Ô∏è Beads command failed: <error message>
        > A) Continue handoff without Beads sync
        > B) Retry the failed command
        > C) Stop - I'll fix the issue first"
        - If A: Skip remaining Beads steps.
        - If B: Retry the command.
        - If C: HALT and wait for user.

3.  **Update Current Task with Context:**
    - Generate task key from current phase/task index (e.g., `phase2_task3`)
    - Look up `beads_task_id` from the `beads_tasks` mapping
    - If found:
      - Run `bd update <beads_task_id> --notes "HANDOFF: <key decisions>, <critical context>, <next steps>"`
    - Format notes for post-compaction recovery (no conversation context assumed)

4.  **Create Beads Handoff Summary:**
    - Run:
      ```bash
      bd update <beads_epic> --notes "
      HANDOFF CONTEXT:
      - Progress: <X>% (<completed>/<total> tasks)
      - Phase: <current_phase>
      - Completed this section: <list>
      - Blockers: <any blocked items>
      - Resume from: <specific task>
      KEY DECISIONS: <decisions made>
      CRITICAL CONTEXT: <must-know info>
      "
      ```

5.  **Parallel Workers Handoff (if parallel_state.json exists):**
    - For each active parallel worker, save Beads context:
      ```bash
      bd update <worker_beads_task_id> --notes "HANDOFF: Worker <id> state saved
      STATUS: <in_progress|completed|pending>
      FILES_OWNED: <exclusive files>
      PROGRESS: <description of work done>
      ASSIGNEE: <worker_id>" --json
      ```
    - Include parallel state summary in epic notes:
      ```bash
      bd update <beads_epic> --notes "...
      PARALLEL_STATE: <N> workers, <M> completed, <K> in progress
      WORKERS: <list of worker_ids and their status>" --json
      ```

6.  **Force Sync to Remote:**
    - Run `bd sync` to ensure changes reach remote immediately

7.  **Announce Beads Sync:**
    > "Handoff context saved to Beads. Context will survive conversation compaction."
"""
