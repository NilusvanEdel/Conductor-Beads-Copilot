description = "Update spec/plan when implementation reveals issues"
prompt = """
## 1.0 SYSTEM DIRECTIVE
Update specifications and plans when implementation reveals issues, requirements change, or scope adjustments are needed.

## 2.0 IDENTIFY ACTIVE TRACK
1. Read `conductor/tracks.md` to find the in-progress track ([~])
2. If no active track, ask user which track to revise
3. Load `conductor/tracks/<track_id>/spec.md` and `plan.md` for context
4. Check for `conductor/tracks/<track_id>/parallel_state.json`

## 2.1 PARALLEL EXECUTION CHECK
If `parallel_state.json` exists:
> "⚠️ This track has parallel workers currently running."
> "Revising the plan may affect in-progress workers."
> 
> "A) Wait for workers to complete, then revise"
> "B) Revise now (affected workers may need restart)"
> "C) Cancel revision"

- If A: Monitor `parallel_state.json` until all complete, then proceed
- If B: Note affected tasks in revision, workers on changed tasks should abort
- If C: HALT

## 3.0 DETERMINE REVISION TYPE
Ask user what needs revision:
> "What needs to be revised?"
> A) **Spec** - Requirements changed or were misunderstood
> B) **Plan** - Tasks need to be added, removed, or modified
> C) **Both** - Significant scope change affecting spec and plan

## 4.0 GATHER REVISION CONTEXT
Ask targeted questions based on revision type:

**For Spec Revisions:**
- What was discovered during implementation?
- Which requirements were wrong/incomplete?
- Are there new requirements to add?

**For Plan Revisions:**
- Which tasks are affected?
- Are there new tasks to add?
- Should any tasks be removed or reordered?

## 5.0 CREATE REVISION RECORD
Create/append to `conductor/tracks/<track_id>/revisions.md`:

```markdown
## Revision [N] - [Date]

**Type:** Spec | Plan | Both
**Trigger:** [What prompted the revision]
**Phase:** [Current phase when revision occurred]
**Task:** [Current task when revision occurred]

### Changes Made
[List of changes]

### Rationale
[Why these changes were necessary]
```

## 6.0 UPDATE DOCUMENTS
1. Present proposed changes to spec.md and/or plan.md
2. Ask for approval
3. Apply changes:
   - New tasks: Insert with `[ ]`
   - Removed tasks: Mark as `[-] [REMOVED: reason]`
   - Modified tasks: Update description
4. **Phase-level parallel changes:**
   - Add/modify `<!-- depends: -->` annotations for phase dependencies
   - Add/modify `<!-- depends: phase1, phase2 -->` for specific phase dependencies
   - If removing a phase that others depend on, update dependent phases
5. **Task-level parallel changes:**
   - Update `<!-- files: ... -->` and `<!-- depends: ... -->` annotations
   - If parallel phase removed: Mark for sequential execution
6. Add revision marker at top of updated files:
   ```markdown
   > **Last Revised:** [Date] - See [revisions.md](revisions.md) for history
   ```

## 7.0 UPDATE STATE
If `implement_state.json` exists, add revision tracking:
```json
{
  "last_revision": "ISO timestamp",
  "revision_count": n,
  "tasks_added": n,
  "tasks_removed": n,
  "current_phase": "...",
  "current_phase_index": 0,
  "current_task_index": 0,
  "completed_phases": []
}
```

## 8.0 COMMIT
```bash
git add conductor/tracks/<track_id>/
git commit -m "conductor(revise): Update spec/plan for <track_id>"
```

## 9.0 ANNOUNCE
Report what was revised:
> "Revision complete for track `<track_id>`:"
> - Spec: [updated/unchanged]
> - Plan: [+N tasks, -M tasks, ~P modified]
> "Run `/conductor:implement` to continue with updated plan."

---

## 10.0 BEADS SYNC

**PROTOCOL: Sync revisions with Beads.**

1. **Check Beads CLI:**
   - Execute `which bd` to check if the Beads CLI is available
   - If `bd` is not found, present the following prompt:
     > "⚠️ Beads CLI (`bd`) is not installed. Beads provides persistent task memory across sessions.
     > A) Continue without Beads sync
     > B) Stop - I'll install Beads first
     >
     > Please respond with A or B."
     - **If A:** Skip remaining Beads steps.
     - **If B:** HALT and wait for user to install Beads.
   - If `bd` is found, continue to load Beads mapping.

2. **Load Beads Mapping:**
   - Read `beads_epic` and `beads_tasks` mapping from track's metadata.json

3. **Sync Task Changes:**
   - For each NEW task added to plan.md:
     - Run `bd create "<task_description>" -P <phase_beads_id>`
     - **Error Handling:** If `bd` command fails:
       > "⚠️ Beads command failed: <error message>
       > A) Continue without Beads sync
       > B) Retry the failed command
       > C) Stop - I'll fix the issue first"
       - If A: Skip remaining Beads steps.
       - If B: Retry the command.
       - If C: HALT and wait for user.
     - Generate new task key (e.g., `phase1_task3`)
     - Add the returned task ID to `beads_tasks` mapping in metadata.json
   - For each REMOVED task:
     - Look up `beads_task_id` from mapping using task key
     - If found, run: `bd close <beads_task_id> --reason "Removed in revision"`
     - Remove the key from `beads_tasks` mapping
   - For each MODIFIED task:
     - Look up `beads_task_id` from mapping using task key
     - If found, run: `bd update <beads_task_id> --notes "Revised: <change_description>"`

4. **Update Dependencies if Order Changed:**
   - If tasks reordered, update Beads dependencies: `bd dep add <child_beads_id> <parent_beads_id>`

5. **Add Revision Note to Epic:**
   - Run `bd note <beads_epic> "Revision [N]: <summary of changes>"`

6. **Parallel Execution Changes (if parallel annotations modified):**
   
   **Phase-Level Dependencies:**
   - If phase `<!-- depends: -->` annotations changed:
     - For phases with NEW dependencies: `bd dep add <phase_id> <dependency_phase_id>`
     - For phases with REMOVED dependencies: Update epic notes to reflect new structure
     - For phases changed to `<!-- depends: -->` (empty - no dependencies):
       - Remove all phase-level dependencies in Beads for this phase
   
   **Task-Level Parallel Config:**
   - For NEW parallel tasks: Add file ownership notes:
     ```bash
     bd update <new_task_id> --notes "PARALLEL_ENABLED: true
     FILES_OWNED: <comma-separated file list>
     DEPENDS_ON: <task dependencies>" --json
     ```
   - For MODIFIED parallel annotations (files/depends changed):
     ```bash
     bd update <task_id> --notes "REVISED: Parallel config changed
     FILES_OWNED: <new file list>
     DEPENDS_ON: <new dependencies>" --json
     ```
   - If parallel phase changed to sequential (or vice versa):
     - Clear/set `PARALLEL_ENABLED` in task notes
     - Clear assignees if reverting to sequential: `bd update <id> --assignee "" --json`
"""
