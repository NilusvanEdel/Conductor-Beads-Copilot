description = "Sync context docs with current codebase state"
prompt = """
## 1.0 SYSTEM DIRECTIVE
Refresh conductor context documentation to match the current state of the codebase. Use when documentation has become stale due to codebase evolution, new dependencies, or shipped features.

## 2.0 VERIFY SETUP
Check these files exist:
- `conductor/product.md`
- `conductor/tech-stack.md`
- `conductor/workflow.md`
- `conductor/tracks.md`

If missing, halt and suggest `/conductor:setup`.

## 3.0 DETERMINE SCOPE
If scope argument provided (`$ARGUMENTS`), use it. Otherwise, ask:

> "What would you like to refresh?
> 1. all - Full refresh of all context documents
> 2. tech - Update tech-stack.md (dependencies, frameworks, tools)
> 3. product - Update product.md (shipped features, evolved goals)
> 4. workflow - Update workflow.md (process changes)
> 5. track [id] - Refresh specific track's spec/plan"

## 4.0 ANALYZE CURRENT STATE

### For `tech` scope:
1. Read current `conductor/tech-stack.md`
2. Scan codebase for:
   - `package.json`, `requirements.txt`, `go.mod`, `Cargo.toml`, `pom.xml`
   - New directories/modules not documented
   - Removed dependencies still documented
3. Compare and identify drift

### For `product` scope:
1. Read current `conductor/product.md`
2. Analyze:
   - Completed tracks in `conductor/tracks.md` (shipped features)
   - README.md changes
   - New major components or features
3. Identify features shipped but not in product.md

### For `workflow` scope:
1. Read current `conductor/workflow.md`
2. Check for:
   - New CI/CD configurations (`.github/workflows/`, etc.)
   - New linting/testing tools
   - Changed commit conventions
3. Identify process drift

### For `track` scope:
1. Load specified track's spec.md and plan.md
2. Compare against actual implementation
3. Identify completed items not marked, or spec drift

### For `all` scope:
- Run all of the above analyses

## 5.0 GENERATE DRIFT REPORT
Present findings to user:

```markdown
## Context Refresh Analysis

**Last setup:** [date from setup_state.json]
**Days since setup:** [N days]

### Tech Stack Drift
- **Added:** [new packages/frameworks detected]
- **Removed:** [packages in docs but not in codebase]
- **Version changes:** [major version updates]

### Product Drift  
- **Shipped features:** [completed tracks not in product.md]
- **New components:** [directories/modules not documented]
- **Goal evolution:** [detected scope changes]

### Workflow Drift
- **New tools:** [CI/CD, linting, testing additions]
- **Process changes:** [detected convention changes]

### Recommended Updates
1. [Specific update 1]
2. [Specific update 2]
```

## 6.0 CONFIRM UPDATES
Ask user:
> "Apply these updates?
> 1. All recommended updates
> 2. Select specific updates
> 3. Cancel"

## 7.0 APPLY UPDATES
For each confirmed update:

1. **Create backup** (for rollback):
   ```bash
   cp conductor/<file>.md conductor/<file>.md.bak
   ```

2. **Apply changes** to relevant files:
   - Update sections with new information
   - Mark deprecated items
   - Add revision timestamp

3. **Add refresh marker** at top of updated files:
   ```markdown
   > **Last Refreshed:** [Date] - Context synced with codebase
   ```

## 8.0 UPDATE REFRESH STATE
Create/update `conductor/refresh_state.json`:
```json
{
  "last_refresh": "ISO timestamp",
  "scope": "all|tech|product|workflow|track",
  "changes_applied": [
    {"file": "tech-stack.md", "changes": ["added X", "removed Y"]}
  ],
  "next_refresh_hint": "ISO timestamp (2 days from now)"
}
```

## 9.0 COMMIT CHANGES
```bash
git add conductor/
git commit -m "conductor(refresh): Sync context with codebase

Scope: [scope]
- [key changes summary]"
```

## 10.0 ANNOUNCE
> "Context refresh complete:
> - tech-stack.md: [updated/unchanged]
> - product.md: [updated/unchanged]
> - workflow.md: [updated/unchanged]
>
> Next suggested refresh: [date 2 days from now]"

---

## 11.0 BEADS DRIFT CHECK (Optional)

**PROTOCOL: Include Beads status in drift analysis if enabled.**

1. **Check Beads Config:**
   - Read `conductor/beads.json`
   - If file doesn't exist or `enabled: false`, skip this section

2. **Analyze Beads vs Conductor Drift:**
   - Compare Beads task statuses with plan.md markers
   - Identify:
     - Tasks marked done in Beads but `[ ]` in plan.md
     - Tasks marked `[x]` in plan.md but open in Beads
     - Orphaned Beads tasks (not linked to any track)

3. **Include in Drift Report:**
   ```
   ### Beads Sync Drift
   - **Beads ahead:** [tasks done in Beads, pending in plan.md]
   - **Conductor ahead:** [tasks done in plan.md, open in Beads]
   - **Orphaned tasks:** [Beads tasks with no conductor link]
   ```

4. **Offer Beads Sync:**
   > "Beads and Conductor are out of sync. Would you like to:"
   > A) Sync Beads → Conductor (trust Beads status)
   > B) Sync Conductor → Beads (trust plan.md status)
   > C) Skip Beads sync

5. **Apply Sync:**
   - If A: Update plan.md markers to match Beads
   - If B: Run `bd update` commands to match plan.md

**CRITICAL:** If `bd` commands fail, log warning but continue refresh.
"""
